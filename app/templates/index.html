{% extends "base.html" %}

{% block title %}Tableau de Bord LeoBot{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}?v=2025">
{% endblock %}

{% block content %}
<!-- Bannière avec CTA -->
<div class="banner">
    <div class="banner-content">
        <h1>Bienvenue sur votre tableau de bord LeoBot</h1>
        <p>Démarrez une conversation et échangez avec votre assistant virtuel.</p>

        <button id="toggleChatBtn">
            <i data-lucide="message-circle"></i>
            Démarrer une Conversation
        </button>
    </div>
    <picture>
        <source srcset="{{ url_for('static', filename='images/banners/banner-small.png') }}" media="(max-width: 480px)">
        <source srcset="{{ url_for('static', filename='images/banners/banner-medium.png') }}" media="(max-width: 768px)">
        <img src="{{ url_for('static', filename='images/banners/banner.png') }}" alt="Banner" class="banner-image">
    </picture>
</div>

<!-- KPIs Principaux -->
<div class="kpi-grid" id="kpiGrid">
    <div class="kpi-card skeleton">
        <div class="kpi-icon" style="background: #e0f2fe;">
            <i data-lucide="activity" style="color: #0284c7;"></i>
        </div>
        <div class="kpi-content">
            <div class="kpi-label">Requêtes API</div>
            <div class="kpi-value" id="totalRequests">--</div>
            <div class="kpi-trend" id="requestsTrend">
                <i data-lucide="trending-up"></i>
                <span>Chargement...</span>
            </div>
        </div>
    </div>

    <div class="kpi-card skeleton">
        <div class="kpi-icon" style="background: #ddd6fe;">
            <i data-lucide="users" style="color: #7c3aed;"></i>
        </div>
        <div class="kpi-content">
            <div class="kpi-label">Utilisateurs Actifs</div>
            <div class="kpi-value" id="activeUsers">--</div>
            <div class="kpi-trend neutral">
                <i data-lucide="minus"></i>
                <span>Total</span>
            </div>
        </div>
    </div>

    <div class="kpi-card skeleton">
        <div class="kpi-icon" style="background: #fce7f3;">
            <i data-lucide="zap" style="color: #db2777;"></i>
        </div>
        <div class="kpi-content">
            <div class="kpi-label">Taux de Succès</div>
            <div class="kpi-value" id="successRate">--</div>
            <div class="kpi-trend positive">
                <i data-lucide="check-circle"></i>
                <span id="successRateLabel">Performance</span>
            </div>
        </div>
    </div>

    <div class="kpi-card skeleton">
        <div class="kpi-icon" style="background: #fef3c7;">
            <i data-lucide="clock" style="color: #f59e0b;"></i>
        </div>
        <div class="kpi-content">
            <div class="kpi-label">Temps de Réponse</div>
            <div class="kpi-value" id="avgResponseTime">--</div>
            <div class="kpi-trend" id="responseTimeTrend">
                <i data-lucide="gauge"></i>
                <span>Moyenne</span>
            </div>
        </div>
    </div>
</div>

<!-- Graphique d'activité -->
<section class="dashboard-section">
    <h2 class="section-title">
        <i data-lucide="trending-up"></i>
        Activité des 7 derniers jours
    </h2>
    <div class="chart-container">
        <canvas id="activityChart" height="80"></canvas>
    </div>
</section>

<!-- Actions rapides -->
<section class="dashboard-section">
    <h2 class="section-title">
        <i data-lucide="zap"></i>
        Actions Rapides
    </h2>
    <div class="actions-grid">
        <a href="{{ url_for('main.reponses') }}" class="action-card">
            <i data-lucide="settings"></i>
            <h3>Configurer les réponses</h3>
            <p>Personnalisez les messages du bot</p>
        </a>
        <a href="{{ url_for('main.base_connaissances') }}" class="action-card">
            <i data-lucide="brain"></i>
            <h3>Base de connaissances</h3>
            <p>Enrichir les connaissances du bot</p>
        </a>
        <a href="{{ url_for('main.config_api') }}" class="action-card">
            <i data-lucide="key"></i>
            <h3>Configuration API</h3>
            <p>Gérer vos clés d'API</p>
        </a>
    </div>
</section>

<!-- Alertes (si nécessaires) -->
<div id="alertsContainer"></div>

<!-- Conteneur du chatbot React -->
<div id="react-chat-root" style="display: none;"></div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    window.MODEL_CONFIG = {
        hasMistral: {{ use_mistral|tojson|safe }},
        hasGPT: {{ openai_key|default(false)|tojson|safe }}
    };
</script>
<script src="{{ url_for('static', filename='js/index.js') }}?v=2025"></script>
{% if main_js %}
    <script src="{{ url_for('static', filename=main_js) }}"></script>
{% endif %}

<!-- Script de chargement des métriques RÉELLES -->
<script>
    let activityChart = null;

    // Fonction pour charger les vraies métriques depuis l'API
    async function loadDashboardMetrics() {
        try {
            const response = await fetch('/api/dashboard/metrics');
            if (!response.ok) {
                throw new Error('Erreur de chargement des métriques');
            }

            const metrics = await response.json();

            // Mise à jour des KPIs
            document.getElementById('totalRequests').textContent = metrics.total_requests.toLocaleString();
            document.getElementById('activeUsers').textContent = metrics.active_users;
            document.getElementById('successRate').textContent = metrics.success_rate + '%';
            document.getElementById('avgResponseTime').textContent = metrics.avg_response_time + 's';

            // Mise à jour des tendances
            const requestsTrend = document.getElementById('requestsTrend');
            if (metrics.trend_direction === 'up') {
                requestsTrend.className = 'kpi-trend positive';
                requestsTrend.innerHTML = '<i data-lucide="trending-up"></i><span>+' + metrics.trend_percentage + '% cette semaine</span>';
            } else if (metrics.trend_direction === 'down') {
                requestsTrend.className = 'kpi-trend negative';
                requestsTrend.innerHTML = '<i data-lucide="trending-down"></i><span>' + metrics.trend_percentage + '% cette semaine</span>';
            } else {
                requestsTrend.className = 'kpi-trend neutral';
                requestsTrend.innerHTML = '<i data-lucide="minus"></i><span>Stable</span>';
            }

            // Mise à jour des stats détaillées
            document.getElementById('totalTokens').textContent = metrics.total_tokens.toLocaleString();
            document.getElementById('mostUsedProvider').textContent = metrics.most_used_provider;
            document.getElementById('totalFaqs').textContent = metrics.total_faqs;
            document.getElementById('requestsThisWeek').textContent = metrics.requests_this_week.toLocaleString();

            // Retirer les squelettes de chargement
            document.querySelectorAll('.skeleton').forEach(el => el.classList.remove('skeleton'));

            // Mise à jour du graphique
            updateActivityChart(metrics.activity_by_day);

            // Mise à jour des alertes intelligentes
            updateAlerts(metrics);

            // Réinitialiser les icônes Lucide
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }

        } catch (error) {
            console.error('Erreur lors du chargement des métriques:', error);

            // Afficher un message d'erreur
            const alertsContainer = document.getElementById('alertsContainer');
            alertsContainer.innerHTML = `
                <div class="alert alert-info">
                    <i data-lucide="info"></i>
                    <div>
                        <strong>Aucune donnée disponible</strong>
                        <p>Les métriques s'afficheront lorsque vous commencerez à utiliser le chatbot. Si vous voyez ce message après utilisation, vérifiez que les migrations de base de données sont à jour avec : flask db upgrade</p>
                    </div>
                </div>
            `;

            // Remplir avec des valeurs par défaut
            document.getElementById('totalRequests').textContent = '0';
            document.getElementById('activeUsers').textContent = '0';
            document.getElementById('successRate').textContent = '0%';
            document.getElementById('avgResponseTime').textContent = '0s';
            document.getElementById('totalTokens').textContent = '0';
            document.getElementById('mostUsedProvider').textContent = 'Aucun';
            document.getElementById('totalFaqs').textContent = '0';
            document.getElementById('requestsThisWeek').textContent = '0';

            // Retirer les squelettes
            document.querySelectorAll('.skeleton').forEach(el => el.classList.remove('skeleton'));

            // Créer un graphique vide
            updateActivityChart([
                {label: 'Lun', count: 0},
                {label: 'Mar', count: 0},
                {label: 'Mer', count: 0},
                {label: 'Jeu', count: 0},
                {label: 'Ven', count: 0},
                {label: 'Sam', count: 0},
                {label: 'Dim', count: 0}
            ]);

            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }
    }

    // Fonction pour mettre à jour le graphique d'activité
    function updateActivityChart(activityData) {
        const ctx = document.getElementById('activityChart');

        if (activityChart) {
            activityChart.destroy();
        }

        const labels = activityData.map(d => d.label);
        const data = activityData.map(d => d.count);

        activityChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Requêtes API',
                    data: data,
                    borderColor: '#0284c7',
                    backgroundColor: 'rgba(2, 132, 199, 0.1)',
                    tension: 0.4,
                    fill: true,
                    pointBackgroundColor: '#0284c7',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 4,
                    pointHoverRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        titleFont: {
                            size: 14
                        },
                        bodyFont: {
                            size: 13
                        },
                        displayColors: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: '#f3f4f6'
                        },
                        ticks: {
                            precision: 0
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    }

    // Fonction pour mettre à jour les alertes intelligentes
    function updateAlerts(metrics) {
        const alertsContainer = document.getElementById('alertsContainer');
        let alerts = [];

        // Alerte si taux de succès faible
        if (metrics.success_rate < 90 && metrics.total_requests > 0) {
            alerts.push(`
                <div class="alert alert-warning">
                    <i data-lucide="alert-triangle"></i>
                    <div>
                        <strong>Taux de succès à surveiller</strong>
                        <p>Le taux de succès est de ${metrics.success_rate}%. Vérifiez les configurations API.</p>
                    </div>
                </div>
            `);
        }

        // Alerte si temps de réponse élevé
        if (metrics.avg_response_time > 3.0 && metrics.total_requests > 0) {
            alerts.push(`
                <div class="alert alert-warning">
                    <i data-lucide="clock"></i>
                    <div>
                        <strong>Temps de réponse élevé</strong>
                        <p>Le temps moyen de réponse est de ${metrics.avg_response_time}s</p>
                    </div>
                </div>
            `);
        }

        // Alerte si croissance importante
        if (metrics.trend_percentage > 50) {
            alerts.push(`
                <div class="alert alert-success">
                    <i data-lucide="trending-up"></i>
                    <div>
                        <strong>Croissance importante</strong>
                        <p>+${metrics.trend_percentage}% de requêtes cette semaine</p>
                    </div>
                </div>
            `);
        }

        // Alerte si aucune donnée
        if (metrics.total_requests === 0) {
            alerts.push(`
                <div class="alert alert-info">
                    <i data-lucide="info"></i>
                    <div>
                        <strong>Aucune activité détectée</strong>
                        <p>Commencez à utiliser le chatbot pour voir les statistiques</p>
                    </div>
                </div>
            `);
        }

        // Si aucune alerte, afficher un message de succès
        if (alerts.length === 0) {
            alerts.push(`
                <div class="alert alert-success">
                    <i data-lucide="check-circle"></i>
                    <div>
                        <strong>Tout fonctionne parfaitement</strong>
                        <p>Toutes les métriques sont dans les normes</p>
                    </div>
                </div>
            `);
        }

        alertsContainer.innerHTML = alerts.join('');

        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    }

    // Charger les métriques au chargement de la page
    document.addEventListener('DOMContentLoaded', function() {
        loadDashboardMetrics();

        // Rafraîchir les métriques toutes les 30 secondes
        setInterval(loadDashboardMetrics, 30000);
    });
</script>
{% endblock %}
