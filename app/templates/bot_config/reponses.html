{% extends "base.html" %}

{% block title %}Configuration des Réponses{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/reponses.css') }}">
{% endblock %}

{% block content %}
<!-- Bannière -->
<div class="banner">
    <div class="banner-content">
        <h1>Configuration des Réponses</h1>
        <p>Personnalisez les messages de votre bot en quelques clics</p>
    </div>
</div>

<!-- Messages Principaux -->
<section class="config-section">
    <h2 class="section-title">
        <i data-lucide="message-circle"></i>
        Messages Principaux
    </h2>

    <div class="config-card">
        <h3>Message de Bienvenue</h3>
        <p class="card-description">Premier message visible par vos visiteurs</p>
        <textarea
            class="message-input"
            id="welcomeMessage"
            rows="2"
            placeholder="Bonjour ! Comment puis-je vous aider ?">{{ settings.bot_welcome if settings.bot_welcome else 'Bonjour ! Comment puis-je vous aider aujourd\'hui ?' }}</textarea>
    </div>

    <div class="config-card">
        <h3>Message d'Au Revoir</h3>
        <p class="card-description">Quand l'utilisateur dit au revoir</p>
        <textarea
            class="message-input"
            id="goodbyeMessage"
            rows="2"
            placeholder="Au revoir ! N'hésitez pas à revenir.">{{ config.goodbye_message if config.goodbye_message else 'Au revoir ! N\'hésitez pas à revenir si vous avez besoin.' }}</textarea>
    </div>

    <div class="config-card">
        <h3>Message Par Défaut</h3>
        <p class="card-description">Quand le bot ne comprend pas</p>
        <textarea
            class="message-input"
            id="fallbackMessage"
            rows="2"
            placeholder="Je n'ai pas bien compris...">{{ config.fallback_message if config.fallback_message else 'Je ne suis pas sûr de comprendre. Pouvez-vous reformuler ?' }}</textarea>
    </div>
</section>

<!-- Ton de Communication -->
<section class="config-section">
    <h2 class="section-title">
        <i data-lucide="volume-2"></i>
        Ton de Communication
    </h2>

    <div class="tone-options">
        <label class="tone-card {{ 'active' if config.communication_style == 'professional' else '' }}">
            <input type="radio" name="tone" value="professional" {{ 'checked' if config.communication_style == 'professional' else '' }}>
            <i data-lucide="briefcase"></i>
            <h3>Professionnel</h3>
            <p>Formel et courtois</p>
        </label>

        <label class="tone-card {{ 'active' if config.communication_style == 'friendly' else '' }}">
            <input type="radio" name="tone" value="friendly" {{ 'checked' if config.communication_style == 'friendly' else '' }}>
            <i data-lucide="smile"></i>
            <h3>Amical</h3>
            <p>Décontracté et chaleureux</p>
        </label>

        <label class="tone-card {{ 'active' if config.communication_style == 'technical' else '' }}">
            <input type="radio" name="tone" value="technical" {{ 'checked' if config.communication_style == 'technical' else '' }}>
            <i data-lucide="cpu"></i>
            <h3>Technique</h3>
            <p>Précis et expert</p>
        </label>
    </div>
</section>

<!-- Bouton de sauvegarde -->
<div class="save-container">
    <button class="save-btn" id="saveBtn">
        <i data-lucide="check"></i>
        Enregistrer
    </button>
    <div class="save-status" id="saveStatus" style="display: none;">
        <i data-lucide="check-circle"></i>
        <span>Modifications enregistrées</span>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Auto-save et gestion des modifications
let saveTimeout;

function autoSave() {
    clearTimeout(saveTimeout);
    saveTimeout = setTimeout(() => {
        saveConfiguration();
    }, 1000);
}

// Écouter les changements
document.querySelectorAll('.message-input, input[name="tone"]').forEach(input => {
    input.addEventListener('input', autoSave);
    input.addEventListener('change', autoSave);
});

// Sauvegarder
document.getElementById('saveBtn').addEventListener('click', saveConfiguration);

function saveConfiguration() {
    const data = {
        welcome_message: document.getElementById('welcomeMessage').value,
        goodbye_message: document.getElementById('goodbyeMessage').value,
        fallback_message: document.getElementById('fallbackMessage').value,
        communication_style: document.querySelector('input[name="tone"]:checked')?.value || 'professional'
    };

    fetch('/responses/api/configuration', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showSaveStatus();
        }
    })
    .catch(error => console.error('Erreur:', error));
}

function showSaveStatus() {
    const status = document.getElementById('saveStatus');
    status.style.display = 'flex';
    setTimeout(() => {
        status.style.display = 'none';
    }, 3000);
}

// Initialiser Lucide
lucide.createIcons();
</script>
{% endblock %}
