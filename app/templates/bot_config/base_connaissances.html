{% extends "base.html" %}

{% block title %}Base de Connaissances{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/common.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/base_connaissances.css') }}">
{% endblock %}

{% block content %}
<div class="knowledge-container">
    <!-- Bannière -->
    <div class="banner">
        <div class="banner-content">
            <h1>Base de Connaissances</h1>
            <p>Enrichissez votre bot avec vos documents et règles métier</p>
        </div>
    </div>

    <!-- État de traitement -->
    <div class="save-status" id="processingStatus">
        <div class="status-indicator">
            <i data-lucide="check-circle"></i>
            <span>Tous les documents sont traités</span>
        </div>
    </div>

    <!-- Upload de Documents -->
    <section class="config-section">
        <h2 class="section-title">
            <i data-lucide="upload"></i>
            Importer des Documents
        </h2>

        <div class="upload-card">
            <div class="upload-zone" id="uploadZone">
                <i data-lucide="cloud-upload"></i>
                <h3>Glissez-déposez vos fichiers ici</h3>
                <p>ou cliquez pour sélectionner</p>
                <input type="file" id="fileInput" multiple accept=".pdf,.doc,.docx,.txt,.xlsx,.xls">
                <div class="supported-formats">
                    <span class="format-tag">PDF</span>
                    <span class="format-tag">Word</span>
                    <span class="format-tag">Excel</span>
                    <span class="format-tag">Text</span>
                </div>
            </div>

            <div class="upload-progress" id="uploadProgress" style="display: none;">
                <div class="progress-bar">
                    <div class="progress-fill"></div>
                </div>
                <span class="progress-text">Téléchargement en cours...</span>
            </div>

            <!-- Catégorisation rapide -->
            <div class="categories-section">
                <label>Catégorie :</label>
                <div class="category-buttons">
                    <button class="scenario-btn" data-category="general">
                        <i data-lucide="folder"></i>
                        <span>Général</span>
                    </button>
                    <button class="scenario-btn" data-category="produits">
                        <i data-lucide="package"></i>
                        <span>Produits</span>
                    </button>
                    <button class="scenario-btn" data-category="procedures">
                        <i data-lucide="list-ordered"></i>
                        <span>Procédures</span>
                    </button>
                    <button class="scenario-btn" data-category="support">
                        <i data-lucide="life-buoy"></i>
                        <span>Support</span>
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- Documents Importés -->
    <section class="config-section">
        <div class="section-header-with-actions">
            <h2 class="section-title">
                <i data-lucide="file-text"></i>
                Documents Importés
            </h2>
            <div class="header-actions">
                <button class="btn-secondary" id="refreshDocs">
                    <i data-lucide="refresh-cw"></i>
                    Actualiser
                </button>
                <button class="btn-secondary" id="exportDocs">
                    <i data-lucide="download"></i>
                    Exporter
                </button>
            </div>
        </div>

        <div class="documents-grid" id="documentsGrid">
            <div class="empty-state">
                <i data-lucide="file-plus"></i>
                <p>Aucun document importé</p>
                <small>Commencez par importer vos premiers fichiers ci-dessus</small>
            </div>
        </div>
    </section>

    <!-- Règles Avancées -->
    <section class="config-section">
        <h2 class="section-title">
            <i data-lucide="settings"></i>
            Règles Avancées
        </h2>

        <div class="rules-grid">
            <div class="rule-card" onclick="knowledgeManager.showRuleEditor('conditional')">
                <i data-lucide="git-branch"></i>
                <h3>Règles Conditionnelles</h3>
                <p>Si... alors... sinon...</p>
            </div>

            <div class="rule-card" onclick="knowledgeManager.showRuleEditor('context')">
                <i data-lucide="message-circle"></i>
                <h3>Règles Contextuelles</h3>
                <p>Basées sur l'historique</p>
            </div>

            <div class="rule-card" onclick="knowledgeManager.showRuleEditor('priority')">
                <i data-lucide="arrow-up"></i>
                <h3>Règles de Priorité</h3>
                <p>Ordre de traitement</p>
            </div>
        </div>

        <!-- Éditeur de règles -->
        <div class="rule-editor" id="ruleEditor" style="display: none;">
            <div class="editor-header">
                <h3>Éditeur de Règles</h3>
                <button class="close-editor" id="closeRuleEditor">
                    <i data-lucide="x"></i>
                </button>
            </div>

            <div class="editor-content">
                <div class="editor-row">
                    <div class="condition-builder">
                        <h4>Conditions</h4>
                        <div id="conditionsList"></div>
                        <button class="scenario-btn add-condition" onclick="knowledgeManager.addCondition()">
                            <i data-lucide="plus"></i>
                            <span>Ajouter une condition</span>
                        </button>
                    </div>

                    <div class="action-builder">
                        <h4>Actions</h4>
                        <div class="form-step">
                            <label>Type d'action</label>
                            <select class="action-type" id="actionType">
                                <option value="respond">Répondre avec</option>
                                <option value="redirect">Rediriger vers</option>
                                <option value="escalate">Escalader vers humain</option>
                            </select>
                        </div>
                        <div class="form-step">
                            <label>Contenu de l'action</label>
                            <textarea class="action-content" id="actionContent" rows="4" placeholder="Contenu de l'action..."></textarea>
                        </div>
                    </div>
                </div>

                <div class="editor-actions">
                    <button class="btn-secondary" id="testRule">
                        <i data-lucide="play"></i>
                        Tester
                    </button>
                    <button class="btn-primary" id="saveRule">
                        <i data-lucide="save"></i>
                        Enregistrer
                    </button>
                </div>
            </div>
        </div>

        <!-- Liste des règles actives -->
        <div class="rules-list-section">
            <div class="rules-stats">
                <span class="stat-item">
                    <strong id="totalRules">0</strong>
                    <small>règles totales</small>
                </span>
                <span class="stat-item">
                    <strong id="activeRules">0</strong>
                    <small>actives</small>
                </span>
            </div>

            <div class="rules-list" id="rulesList">
                <div class="empty-state">
                    <i data-lucide="settings"></i>
                    <p>Aucune règle configurée</p>
                    <small>Créez vos premières règles avancées ci-dessus</small>
                </div>
            </div>
        </div>
    </section>

    <!-- Actions Globales -->
    <div class="global-actions">
        <button class="btn-secondary" id="exportKnowledge">
            <i data-lucide="download"></i>
            Exporter tout
        </button>
        <button class="btn-secondary" id="importKnowledge">
            <i data-lucide="upload"></i>
            Importer
        </button>
        <button class="btn-primary" id="optimizeKnowledge">
            <i data-lucide="zap"></i>
            Optimiser
        </button>
        <button class="btn-primary" id="saveAllKnowledge">
            <i data-lucide="save"></i>
            Tout Sauvegarder
        </button>
    </div>
</div>

<!-- Modales -->
<div class="modal" id="documentModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Détails du Document</h3>
            <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <div id="documentDetails"></div>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" id="reprocessDoc">Retraiter</button>
            <button class="btn-primary" id="updateDoc">Modifier</button>
        </div>
    </div>
</div>

<div class="modal" id="confirmModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Confirmation</h3>
            <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <p id="confirmMessage">Êtes-vous sûr de vouloir effectuer cette action ?</p>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" id="confirmCancel">Annuler</button>
            <button class="btn-primary" id="confirmOk">Confirmer</button>
        </div>
    </div>
</div>

<!-- Formulaire catégorie personnalisée (caché) -->
<div id="newCategoryForm" style="display: none;">
    <input type="text" id="categoryName" placeholder="Nom de la catégorie">
    <input type="text" id="categoryDescription" placeholder="Description">
    <button id="saveCategory">Créer</button>
    <button id="cancelCategory">Annuler</button>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/base_connaissances.js') }}"></script>
{% endblock %}
