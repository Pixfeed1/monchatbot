{% extends "base.html" %}

{% block title %}Base de Connaissances{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/common.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/content.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/base_connaissances.css') }}">
{% endblock %}

{% block content %}
<div class="knowledge-container">
    <!-- En-tête avec assistant -->
    <div class="knowledge-header">
        <h1><i data-lucide="brain"></i> Base de Connaissances</h1>
        <p class="subtitle">Importez des documents et configurez des règles avancées pour enrichir votre bot</p>
        
        <!-- Indicateur de progression -->
        <div class="progress-indicator">
            <div class="progress-step active" data-step="1">
                <span class="step-number">1</span>
                <span class="step-label">Documents</span>
            </div>
            <div class="progress-step" data-step="2">
                <span class="step-number">2</span>
                <span class="step-label">Règles avancées</span>
            </div>
        </div>
    </div>

    <!-- État de traitement -->
    <div class="save-status" id="processingStatus">
        <div class="status-indicator">
            <i data-lucide="check-circle"></i>
            <span>Tous les documents sont traités</span>
        </div>
    </div>

    <!-- Navigation simplifiée -->
    <div class="wizard-navigation">
        <button class="nav-btn active" data-section="documents">
            <i data-lucide="file-text"></i>
            <span>Documents</span>
            <small>Importez vos fichiers</small>
        </button>
        <button class="nav-btn" data-section="rules">
            <i data-lucide="settings"></i>
            <span>Règles Avancées</span>
            <small>Logique complexe</small>
        </button>
    </div>

    <!-- Section Documents -->
    <div class="wizard-section active" id="documents">
        <div class="section-header">
            <h2>Gestion des Documents</h2>
            <p>Importez des fichiers PDF, Word, Excel pour enrichir les connaissances de votre bot</p>
        </div>

        <!-- Zone d'upload moderne -->
        <div class="upload-section">
            <div class="upload-zone" id="uploadZone">
                <div class="upload-icon">
                    <i data-lucide="cloud-upload"></i>
                </div>
                <h3>Glissez-déposez vos fichiers ici</h3>
                <p>ou cliquez pour sélectionner</p>
                <input type="file" id="fileInput" multiple accept=".pdf,.doc,.docx,.txt,.xlsx,.xls">
                <div class="supported-formats">
                    <span class="format-tag">PDF</span>
                    <span class="format-tag">Word</span>
                    <span class="format-tag">Excel</span>
                    <span class="format-tag">Text</span>
                </div>
            </div>
            
            <!-- Progression d'upload -->
            <div class="upload-progress" id="uploadProgress" style="display: none;">
                <div class="progress-bar">
                    <div class="progress-fill"></div>
                </div>
                <span class="progress-text">Téléchargement en cours...</span>
            </div>
        </div>

        <!-- Assistant de catégorisation -->
        <div class="creation-assistant">
            <div class="assistant-header">
                <i data-lucide="wand-2"></i>
                <h3>Assistant de Catégorisation</h3>
            </div>
            <div class="assistant-content">
                <p>Organisez vos documents par catégories pour une meilleure recherche</p>
                <div class="scenarios-grid">
                    <button class="scenario-btn" data-category="general">
                        <i data-lucide="folder"></i>
                        <span>Général</span>
                    </button>
                    <button class="scenario-btn" data-category="produits">
                        <i data-lucide="package"></i>
                        <span>Produits/Services</span>
                    </button>
                    <button class="scenario-btn" data-category="procedures">
                        <i data-lucide="list-ordered"></i>
                        <span>Procédures</span>
                    </button>
                    <button class="scenario-btn" data-category="support">
                        <i data-lucide="life-buoy"></i>
                        <span>Support</span>
                    </button>
                    <button class="scenario-btn" data-category="legal">
                        <i data-lucide="scale"></i>
                        <span>Légal</span>
                    </button>
                    <button class="scenario-btn" data-category="custom">
                        <i data-lucide="plus"></i>
                        <span>Personnalisé</span>
                    </button>
                </div>
                
                <!-- Formulaire de nouvelle catégorie -->
                <div class="guided-form" id="newCategoryForm" style="display: none;">
                    <div class="form-step">
                        <label>Nom de la catégorie</label>
                        <input type="text" id="categoryName" placeholder="Ex: Documentation technique">
                    </div>
                    <div class="form-step">
                        <label>Description (optionnel)</label>
                        <input type="text" id="categoryDescription" placeholder="Description de la catégorie">
                    </div>
                    <div class="form-actions">
                        <button class="btn-secondary" id="cancelCategory">Annuler</button>
                        <button class="btn-primary" id="saveCategory">Créer</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Liste des documents -->
        <div class="custom-responses">
            <h3>Documents Importés</h3>
            <div class="list-actions" style="margin-bottom: 1rem;">
                <button class="btn-secondary" id="refreshDocs">
                    <i data-lucide="refresh-cw"></i>
                    Actualiser
                </button>
                <button class="btn-secondary" id="exportDocs">
                    <i data-lucide="download"></i>
                    Exporter
                </button>
            </div>
            
            <div class="responses-list" id="documentsGrid">
                <!-- Les documents seront chargés dynamiquement -->
                <div class="empty-state">
                    <i data-lucide="file-plus"></i>
                    <p>Aucun document importé</p>
                    <small>Commencez par importer vos premiers fichiers ci-dessus</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Section Règles Avancées -->
    <div class="wizard-section" id="rules">
        <div class="section-header">
            <h2>Règles Avancées</h2>
            <p>Configurez la logique complexe de traitement des questions</p>
        </div>

        <!-- Types de règles -->
        <div class="templates-grid">
            <div class="template-card" data-type="conditional">
                <div class="template-header">
                    <i data-lucide="git-branch" class="template-icon"></i>
                    <h3>Règles Conditionnelles</h3>
                    <button class="toggle-template active">
                        <i data-lucide="toggle-right"></i>
                    </button>
                </div>
                <div class="template-content">
                    <div class="quick-setup">
                        <p><strong>Utilisation:</strong> Si... alors... sinon...</p>
                        <button class="btn-primary" onclick="knowledgeManager.showRuleEditor('conditional')">
                            Créer une règle
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="template-card" data-type="context">
                <div class="template-header">
                    <i data-lucide="message-circle" class="template-icon"></i>
                    <h3>Règles Contextuelles</h3>
                    <button class="toggle-template active">
                        <i data-lucide="toggle-right"></i>
                    </button>
                </div>
                <div class="template-content">
                    <div class="quick-setup">
                        <p><strong>Utilisation:</strong> Basées sur l'historique de conversation</p>
                        <button class="btn-primary" onclick="knowledgeManager.showRuleEditor('context')">
                            Créer une règle
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="template-card" data-type="priority">
                <div class="template-header">
                    <i data-lucide="arrow-up-0-1" class="template-icon"></i>
                    <h3>Règles de Priorité</h3>
                    <button class="toggle-template active">
                        <i data-lucide="toggle-right"></i>
                    </button>
                </div>
                <div class="template-content">
                    <div class="quick-setup">
                        <p><strong>Utilisation:</strong> Ordre de traitement des réponses</p>
                        <button class="btn-primary" onclick="knowledgeManager.showRuleEditor('priority')">
                            Créer une règle
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Éditeur de règles -->
        <div class="creation-assistant" id="ruleEditor" style="display: none;">
            <div class="assistant-header">
                <i data-lucide="settings"></i>
                <h3>Éditeur de Règles</h3>
                <button class="close-editor" id="closeRuleEditor">
                    <i data-lucide="x"></i>
                </button>
            </div>
            
            <div class="assistant-content">
                <div class="scenarios-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="condition-builder">
                        <h4>Conditions</h4>
                        <div id="conditionsList">
                            <!-- Les conditions seront ajoutées dynamiquement -->
                        </div>
                        <button class="scenario-btn" onclick="knowledgeManager.addCondition()">
                            <i data-lucide="plus"></i>
                            <span>Ajouter une condition</span>
                        </button>
                    </div>
                    
                    <div class="action-builder">
                        <h4>Actions</h4>
                        <div class="form-step">
                            <label>Type d'action</label>
                            <select id="actionType">
                                <option value="respond">Répondre avec</option>
                                <option value="redirect">Rediriger vers</option>
                                <option value="escalate">Escalader vers humain</option>
                            </select>
                        </div>
                        <div class="form-step">
                            <label>Contenu de l'action</label>
                            <textarea id="actionContent" rows="4" placeholder="Contenu de l'action..."></textarea>
                        </div>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button class="btn-secondary" id="testRule">
                        <i data-lucide="play"></i>
                        Tester la règle
                    </button>
                    <button class="btn-primary" id="saveRule">
                        <i data-lucide="save"></i>
                        Enregistrer
                    </button>
                </div>
            </div>
        </div>

        <!-- Liste des règles actives -->
        <div class="custom-responses">
            <div class="responses-section-header">
                <h3>Règles Actives</h3>
                <div class="responses-count">
                    <span class="stat-item">
                        <strong id="totalRules">0</strong>
                        <small>règles totales</small>
                    </span>
                    <span class="stat-item" style="margin-left: 1rem;">
                        <strong id="activeRules">0</strong>
                        <small>actives</small>
                    </span>
                </div>
            </div>
            
            <div class="responses-list" id="rulesList">
                <div class="empty-state">
                    <i data-lucide="settings"></i>
                    <p>Aucune règle configurée</p>
                    <small>Créez vos premières règles avancées ci-dessus</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Actions globales -->
    <div class="global-actions">
        <div class="actions-left">
            <button class="btn-secondary" id="exportKnowledge">
                <i data-lucide="download"></i>
                Exporter tout
            </button>
            <button class="btn-secondary" id="importKnowledge">
                <i data-lucide="upload"></i>
                Importer configuration
            </button>
        </div>
        <div class="actions-right">
            <button class="btn-primary" id="optimizeKnowledge">
                <i data-lucide="wand-2"></i>
                Optimiser la base
            </button>
            <button class="btn-primary" id="saveAllKnowledge">
                <i data-lucide="save"></i>
                Tout Sauvegarder
            </button>
        </div>
    </div>
</div>

<!-- Modales -->
<div class="modal" id="documentModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Détails du Document</h3>
            <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <div id="documentDetails">
                <!-- Contenu dynamique -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" id="reprocessDoc">Retraiter</button>
            <button class="btn-primary" id="updateDoc">Modifier</button>
        </div>
    </div>
</div>

<div class="modal" id="confirmModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Confirmation</h3>
            <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <p id="confirmMessage">Êtes-vous sûr de vouloir effectuer cette action ?</p>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" id="confirmCancel">Annuler</button>
            <button class="btn-primary" id="confirmOk">Confirmer</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/base_connaissances.js') }}"></script>
{% endblock %}