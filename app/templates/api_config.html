{% extends "base.html" %}

{% block title %}Configuration API{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/general_settings.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/api_config.css') }}">
{% endblock %}

{% block content %}
<h1>Configuration API</h1>

<div class="flash-messages">
    {% with messages = get_flashed_messages() %}
        {% if messages %}
            {% for message in messages %}
                <div class="flash success">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}
</div>

<!-- Formulaire principal -->
<form id="apiConfigForm" method="POST" class="settings">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    
    <!-- S√©lection du provider -->
    <label for="provider_select">Choisissez votre fournisseur d'API :</label>
    <select id="provider_select" name="provider_select" required>
        <option value="">-- S√©lectionnez un provider --</option>
        <option value="openai" {% if current_config.provider == 'openai' %}selected{% endif %}>OpenAI (GPT)</option>
        <option value="mistral" {% if current_config.provider == 'mistral' %}selected{% endif %}>Mistral AI</option>
        <option value="claude" {% if current_config.provider == 'claude' %}selected{% endif %}>Claude (Anthropic)</option>
    </select>
    
    <!-- Section OpenAI (cach√©e par d√©faut) -->
    <div id="openai_section" class="api-section hidden">
        <h3>Configuration OpenAI</h3>
        
        <label for="gpt_key">Cl√© API OpenAI :</label>
        <input type="password" id="gpt_key" name="gpt_key" 
               placeholder="sk-proj-xxxxxxxxxxxxxxxxx ou sk-xxxxxxxxxxxxxxxxx"
               autocomplete="off">
        <small style="color: #666;">Votre cl√© API commence g√©n√©ralement par "sk-"</small>
        
        <label for="model_select">Mod√®le GPT :</label>
        <select id="model_select" name="model_select">
            <option value="gpt-3.5-turbo" {% if current_config.openai_model == 'gpt-3.5-turbo' %}selected{% endif %}>GPT-3.5 Turbo (Recommand√©)</option>
            <option value="gpt-4o-mini" {% if current_config.openai_model == 'gpt-4o-mini' %}selected{% endif %}>GPT-4o Mini</option>
            <option value="gpt-4o" {% if current_config.openai_model == 'gpt-4o' %}selected{% endif %}>GPT-4o</option>
            <option value="gpt-4" {% if current_config.openai_model == 'gpt-4' %}selected{% endif %}>GPT-4</option>
            <option value="gpt-4-turbo" {% if current_config.openai_model == 'gpt-4-turbo' %}selected{% endif %}>GPT-4 Turbo</option>
        </select>
        
        <button type="button" id="test_openai" class="test-btn" disabled>Tester la connexion OpenAI</button>
    </div>
    
    <!-- Section Mistral (cach√©e par d√©faut) -->
    <div id="mistral_section" class="api-section hidden">
        <h3>Configuration Mistral AI</h3>
        
        <label for="mistral_key">Cl√© API Mistral :</label>
        <input type="password" id="mistral_key" name="mistral_key" 
               placeholder="Votre cl√© API Mistral..."
               autocomplete="off">
        <small style="color: #666;">R√©cup√©rez votre cl√© sur console.mistral.ai</small>
        
        <label for="mistral_model">Mod√®le Mistral :</label>
        <select id="mistral_model" name="mistral_model">
            <option value="mistral-small" {% if current_config.mistral_model == 'mistral-small' %}selected{% endif %}>Mistral Small (Recommand√©)</option>
            <option value="mistral-medium" {% if current_config.mistral_model == 'mistral-medium' %}selected{% endif %}>Mistral Medium</option>
            <option value="mistral-large" {% if current_config.mistral_model == 'mistral-large' %}selected{% endif %}>Mistral Large</option>
            <option value="open-mistral-7b" {% if current_config.mistral_model == 'open-mistral-7b' %}selected{% endif %}>Open Mistral 7B</option>
        </select>
        
        <button type="button" id="test_mistral" class="test-btn" disabled>Tester la connexion Mistral</button>
    </div>

    <!-- Section Claude (cach√©e par d√©faut) -->
    <div id="claude_section" class="api-section hidden">
        <h3>Configuration Claude (Anthropic)</h3>

        <label for="claude_key">Cl√© API Claude :</label>
        <input type="password" id="claude_key" name="claude_key"
               placeholder="sk-ant-xxxxxxxxxxxxxxxxx"
               autocomplete="off">
        <small style="color: #666;">Votre cl√© API commence par "sk-ant-"</small>

        <label for="claude_model">Mod√®le Claude :</label>
        <select id="claude_model" name="claude_model">
            <option value="claude-sonnet-4" {% if current_config.claude_model == 'claude-sonnet-4' %}selected{% endif %}>Claude Sonnet 4 (Recommand√©)</option>
            <option value="claude-sonnet-4-5" {% if current_config.claude_model == 'claude-sonnet-4-5' %}selected{% endif %}>Claude Sonnet 4.5 (Meilleur pour le code)</option>
            <option value="claude-opus-4-1" {% if current_config.claude_model == 'claude-opus-4-1' %}selected{% endif %}>Claude Opus 4.1 (Le plus puissant)</option>
            <option value="claude-haiku-4-5" {% if current_config.claude_model == 'claude-haiku-4-5' %}selected{% endif %}>Claude Haiku 4.5 (Rapide et √©conomique)</option>
            <option value="claude-3-7-sonnet" {% if current_config.claude_model == 'claude-3-7-sonnet' %}selected{% endif %}>Claude 3.7 Sonnet (Raisonnement hybride)</option>
        </select>

        <button type="button" id="test_claude" class="test-btn" disabled>Tester la connexion Claude</button>
    </div>

    <!-- Zone de r√©sultats de test (cach√©e par d√©faut) -->
    <div id="test_results" class="test-zone hidden"></div>
    
    <!-- Bouton de sauvegarde -->
    <button type="submit" id="save_config" disabled>Choisissez d'abord un provider</button>
</form>

<!-- Informations d'aide -->
<div style="max-width: 600px; margin: 2rem auto; padding: 1rem; background-color: #e3f2fd; border-radius: 6px;">
    <h4 style="color: #1976d2; margin-bottom: 0.5rem;">üí° Informations importantes</h4>
    <ul style="margin: 0; padding-left: 1.5rem; color: #555;">
        <li>Vos cl√©s API sont chiffr√©es et stock√©es de mani√®re s√©curis√©e</li>
        <li>OpenAI : Cr√©ez votre cl√© sur <a href="https://platform.openai.com/api-keys" target="_blank">platform.openai.com</a></li>
        <li>Mistral : Cr√©ez votre cl√© sur <a href="https://console.mistral.ai/" target="_blank">console.mistral.ai</a></li>
        <li>Claude : Cr√©ez votre cl√© sur <a href="https://console.anthropic.com/" target="_blank">console.anthropic.com</a></li>
        <li>Testez toujours votre cl√© avant de sauvegarder</li>
    </ul>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/api_config.js') }}"></script>
{% endblock %}